<!DOCTYPE html>
<html lang="ru">
    <head>
		<meta charset="utf-8" />
		<meta http-equiv="X-UA-Compatible" content="chrome=1" />
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />

		<meta name="author" content="Dmitrij Koniajev" />		
        <title>Имплементация HyperLogLog на C# - Непутёвые заметки Димчанского</title>
		<link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet" />
		<style>
			@import url("https://fonts.googleapis.com/css2?family=Fira+Mono:wght@400;500&family=Fira+Sans:ital,wght@0,300;0,400;0,500;1,300;1,400;1,500&family=Merriweather:ital,wght@0,300;0,400;1,300;1,400&display=swap");
		</style>
		<link rel="stylesheet" href="../../../../../css/main.min.css?v=b1c8ca" />

		<!-- Google tag (gtag.js) -->
		<script async src="https://www.googletagmanager.com/gtag/js?id=G-B1YE0YL6FD"></script>
		<script>
			window.dataLayer = window.dataLayer || [];
			function gtag(){dataLayer.push(arguments);}
			gtag('js', new Date());
			gtag('config', 'G-B1YE0YL6FD');
		</script>

		
		<!-- KaTeX -->
		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.7/dist/katex.min.css" integrity="sha384-3UiQGuEI4TTMaFmGIZumfRPtfKQ3trwQE2JgosJxCnGmQpL/lJdjpcHkaaFwHlcI" crossorigin="anonymous" />
		<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.7/dist/katex.min.js" integrity="sha384-G0zcxDFp5LWZtDuRMnBkk3EphCK1lhEf4UEyEM693ka574TZGwo4IWwS6QLzM/2t" crossorigin="anonymous"></script>
		<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.7/dist/contrib/auto-render.min.js" integrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05" crossorigin="anonymous" onload="renderMathInElement(document.body);"></script>
		<!-- End KaTeX Code -->
		
    </head>
	<body>
	<div id="wrapper">
		<div id="header">
			<div class="header-logo"><h1><a href="../../../../../">Непутёвые заметки Димчанского</a></h1></div>
			<div class="header-links">
				<a href="https://twitter.com/dimchansky"><i class="fa fa-twitter fa-fw fa-2x"></i></a>
				<a href="https://github.com/dimchansky"><i class="fa fa-github fa-fw fa-2x"></i></a>
				<a href="https://www.linkedin.com/in/dimchansky"><i class="fa fa-linkedin fa-fw fa-2x"></i></a>
				<a href="https://www.youtube.com/user/Dimchansky"><i class="fa fa-youtube fa-fw fa-2x"></i></a>
				<a href="../../../../../atom.xml"><i class="fa fa-rss fa-fw fa-2x"></i></a>
			</div>
		</div>

		<div id="content">
			<article>
<header>
<h1>Имплементация HyperLogLog на C#</h1>

<p>Дата: <strong>October 26, 2014</strong></p>
<p>Метки: <a title="All pages tagged 'cardinality-estimation'." href="../../../../../tags/cardinality-estimation.html" rel="tag">cardinality-estimation</a>, <a title="All pages tagged 'big-data'." href="../../../../../tags/big-data.html" rel="tag">big-data</a>, <a title="All pages tagged 'HyperLogLog'." href="../../../../../tags/HyperLogLog.html" rel="tag">HyperLogLog</a>, <a title="All pages tagged 'C#'." href="../../../../../tags/C%23.html" rel="tag">C#</a>, <a title="All pages tagged 'FNV'." href="../../../../../tags/FNV.html" rel="tag">FNV</a>, <a title="All pages tagged 'MurmurHash3'." href="../../../../../tags/MurmurHash3.html" rel="tag">MurmurHash3</a></p>
</header>

<section>

<nav id="toc" role="doc-toc">
<strong>Содержание</strong>
<label for="contents">⊕</label>
<input type="checkbox" id="contents">
<ul>
<li><a href="#описание-реализованных-методов" id="toc-описание-реализованных-методов">Описание реализованных методов</a></li>
<li><a href="#проверяем-правильность-работы-алгоритма-на-случайных-данных" id="toc-проверяем-правильность-работы-алгоритма-на-случайных-данных">Проверяем правильность работы алгоритма на случайных данных</a></li>
<li><a href="#выбираем-функцию-хеширования" id="toc-выбираем-функцию-хеширования">Выбираем функцию хеширования</a></li>
<li><a href="#объединяем-результаты" id="toc-объединяем-результаты">Объединяем результаты</a></li>
<li><a href="#MurmurHash3" id="toc-MurmurHash3">Имплементация хеш-функции MurmurHash3 на C#</a></li>
<li><a href="#HyperLogLogCode" id="toc-HyperLogLogCode">Имплементация алгоритма HyperLogLog на C#</a></li>
</ul>
</nav>
<h2 id="описание-реализованных-методов">Описание реализованных методов</h2>
<p>Исходя из <a href="../../../../../posts/2014/10/20/cardinality-estimation-using-hyperloglog/#HyperLogLog">описания алгоритма HyperLogLog</a>
его имплементация не должна представлять особых проблем. Ниже представлено <a href="#HyperLogLogCode">переложение алгоритма HyperLogLog на C#</a>.</p>
<ul>
<li>Конструктор <code class="sourceCode cs"><span class="kw">public</span> <span class="fu">HyperLogLog</span><span class="op">(</span><span class="dt">int</span> k<span class="op">)</span></code> принимает параметр k=4..16 такое, что \( m={ 2 }^{ k } \) - число байтовых регистров, которое будет выделено
в оперативной памяти для приблизительного подсчета числа уникальных элементов лежащего в интервале \( \left[ 0,10^9 \right] \). При этом стандартная ошибка
при оценке числа уникальных элементов будет составлять \( \frac { 1.04 }{ \sqrt { { 2 }^{ k } } } \).</li>
<li>Метод <code class="sourceCode cs"><span class="kw">public</span> <span class="dt">void</span> <span class="fu">Add</span><span class="op">(</span><span class="dt">int</span> hash<span class="op">)</span></code> принимает 32-битный хеш элемента из набора, в котором нужно оценить число уникальных элементов. В главе
<a href="../../../../../posts/2014/10/20/cardinality-estimation-using-hyperloglog/#hashing">о хешировании</a> можно прочесть слова Дональда Кнута, который говорит, что на
практике возможно создать хеш-функцию, которая бы из неслучайных данных создавала данные хоть и не совсем случайные, но очень похожие на случайные.
Этому стоит уделить особое внимание, потому что недостаточно хорошая хеш-функция, которая будет генерировать хеши не похожие на случайные, сведет
весь алгоритм на нет.
В реализации метода можно можно увидеть, что после получения индекса регистра из хеша (по первым k битам) далее ведется подсчет младших нулевых битов, а не
старших, как это описано в алгоритме. На самом деле совершенно нет разницы, считаем мы последовательность нулевых битов в старших битах или в младших,
ведь хеш - это <em>как бы</em> случайное число.</li>
<li>Метод <code class="sourceCode cs"><span class="kw">public</span> <span class="dt">double</span> <span class="fu">EstimateCount</span><span class="op">()</span></code> позволяет произвести оценку числа уникальных элементов, хеши которых были ранее добавлены через вызов метода
<code class="sourceCode cs"><span class="kw">public</span> <span class="dt">void</span> <span class="fu">Add</span><span class="op">(</span><span class="dt">int</span> hash<span class="op">)</span></code>.</li>
<li>Наконец метод <code class="sourceCode cs"><span class="kw">public</span> <span class="dt">void</span> <span class="fu">UnionWith</span><span class="op">(</span>HyperLogLog other<span class="op">)</span></code> позволяет объединить уникальные элементы из разных наборов. Это может быть полезно, если, например,
исходная выборка была разбита на несколько частей и для каждой части независимо производилась оценка числа уникальных элементов. Очень важно помнить, что
объединяемые объекты класса <code class="sourceCode cs">HyperLogLog</code> должны использовать то же самое число регистров (параметр k должен быть одним и тем же) и для добавляемых
элементов должна использоваться одна и та же хеш-функция. Нельзя использовать для двух разных объектов класса <code class="sourceCode cs">HyperLogLog</code> две разные пусть и очень хорошие
хеш-функции, т.к. в результате в лучшем случае получится сумма уникальных элементов из каждого набора по отдельности, в худшем случае просто чепуха.</li>
</ul>
<h2 id="проверяем-правильность-работы-алгоритма-на-случайных-данных">Проверяем правильность работы алгоритма на случайных данных</h2>
<p>Прежде чем пробовать алгоритм на каких-то реальных данных, проверим, насколько хорошо он работает на случайных. То есть вместо хешей будем подавать
случайные хеши (предполагая, что коллизий будет мало) и проверять на сколько алгоритм ошибается в оценке.</p>
<p>Для проверки возьмем криптографический генератор случайных чисел, не будем полагаться на простой random. Напишем такой генератор бесконечного списка случайных
32-битных чисел:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode cs"><code class="sourceCode cs"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>IEnumerable<span class="op">&lt;</span><span class="dt">int</span><span class="op">&gt;</span> <span class="fu">GetRandomInts</span><span class="op">()</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">var</span> rng <span class="op">=</span> <span class="kw">new</span> System<span class="op">.</span><span class="fu">Security</span><span class="op">.</span><span class="fu">Cryptography</span><span class="op">.</span><span class="fu">RNGCryptoServiceProvider</span><span class="op">();</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">var</span> intBytes <span class="op">=</span> <span class="kw">new</span> <span class="dt">byte</span><span class="op">[</span><span class="dv">4</span><span class="op">];</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">while</span><span class="op">(</span><span class="kw">true</span><span class="op">)</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>        rng<span class="op">.</span><span class="fu">GetBytes</span><span class="op">(</span>intBytes<span class="op">);</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>        <span class="dt">var</span> rndInt <span class="op">=</span> BitConverter<span class="op">.</span><span class="fu">ToInt32</span><span class="op">(</span>intBytes<span class="op">,</span> <span class="dv">0</span><span class="op">);</span>     </span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>        <span class="kw">yield</span> <span class="kw">return</span> rndInt<span class="op">;</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>Прогоним теперь через объект класса <code class="sourceCode cs">HyperLogLog</code> наши случайные числа и в определенных точках сверим оценку с числом поданых случайных чисел:</p>
<div class="sourceCode" id="testCode"><pre class="sourceCode cs"><code class="sourceCode cs"><span id="testCode-1"><a href="#testCode-1" aria-hidden="true" tabindex="-1"></a><span class="co">// здесь будут точки, в которых будем производить оценку</span></span>
<span id="testCode-2"><a href="#testCode-2" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> ticks <span class="op">=</span> <span class="kw">new</span> HashSet<span class="op">&lt;</span><span class="dt">int</span><span class="op">&gt;(</span>Enumerable</span>
<span id="testCode-3"><a href="#testCode-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">Range</span><span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="dv">8</span><span class="op">)</span></span>
<span id="testCode-4"><a href="#testCode-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">Select</span><span class="op">(</span>i <span class="op">=&gt;</span> <span class="op">(</span><span class="dt">int</span><span class="op">)</span>Math<span class="op">.</span><span class="fu">Pow</span><span class="op">(</span><span class="dv">10</span><span class="op">,</span>i<span class="op">))</span></span>
<span id="testCode-5"><a href="#testCode-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">SelectMany</span><span class="op">(</span>i <span class="op">=&gt;</span> <span class="kw">new</span><span class="op">[]{</span>i<span class="op">,</span> <span class="dv">5</span><span class="op">*</span>i<span class="op">}));</span></span>
<span id="testCode-6"><a href="#testCode-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="testCode-7"><a href="#testCode-7" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> hll <span class="op">=</span> <span class="kw">new</span> <span class="fu">HyperLogLog</span><span class="op">(</span><span class="dv">10</span><span class="op">);</span> <span class="co">// k = 10</span></span>
<span id="testCode-8"><a href="#testCode-8" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> cnt <span class="op">=</span> <span class="dv">0</span><span class="op">;</span>                   <span class="co">// число добавленных хешей</span></span>
<span id="testCode-9"><a href="#testCode-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="testCode-10"><a href="#testCode-10" aria-hidden="true" tabindex="-1"></a>Console<span class="op">.</span><span class="fu">WriteLine</span><span class="op">(</span><span class="st">&quot;| Разных значений | Оценка     | Ошибка,% |&quot;</span><span class="op">);</span></span>
<span id="testCode-11"><a href="#testCode-11" aria-hidden="true" tabindex="-1"></a>Console<span class="op">.</span><span class="fu">WriteLine</span><span class="op">(</span><span class="st">&quot;|----------------:|-----------:|:--------:|&quot;</span><span class="op">);</span></span>
<span id="testCode-12"><a href="#testCode-12" aria-hidden="true" tabindex="-1"></a><span class="kw">foreach</span> <span class="op">(</span><span class="dt">var</span> hash <span class="kw">in</span> <span class="fu">GetRandomInts</span><span class="op">().</span><span class="fu">Take</span><span class="op">(</span><span class="dv">100000000</span><span class="op">))</span></span>
<span id="testCode-13"><a href="#testCode-13" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="testCode-14"><a href="#testCode-14" aria-hidden="true" tabindex="-1"></a>    hll<span class="op">.</span><span class="fu">Add</span><span class="op">(</span>hash<span class="op">);</span> <span class="co">// добавляем хеш</span></span>
<span id="testCode-15"><a href="#testCode-15" aria-hidden="true" tabindex="-1"></a>    cnt<span class="op">++;</span>         <span class="co">// увеличиваем число добавленных хешей</span></span>
<span id="testCode-16"><a href="#testCode-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="testCode-17"><a href="#testCode-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> <span class="op">(!</span>ticks<span class="op">.</span><span class="fu">Contains</span><span class="op">(</span>cnt<span class="op">))</span> <span class="op">{</span> <span class="kw">continue</span><span class="op">;</span> <span class="op">}</span></span>
<span id="testCode-18"><a href="#testCode-18" aria-hidden="true" tabindex="-1"></a>    <span class="co">// производим оценку и вычисляем ошибку</span></span>
<span id="testCode-19"><a href="#testCode-19" aria-hidden="true" tabindex="-1"></a>    <span class="dt">var</span> estimateCount <span class="op">=</span> hll<span class="op">.</span><span class="fu">EstimateCount</span><span class="op">();</span></span>
<span id="testCode-20"><a href="#testCode-20" aria-hidden="true" tabindex="-1"></a>    Console<span class="op">.</span><span class="fu">WriteLine</span><span class="op">(</span><span class="st">&quot;|{0,17}|{1,12:0.00}|{2,10:0.0000}|&quot;</span><span class="op">,</span> cnt<span class="op">,</span> estimateCount<span class="op">,</span> Math<span class="op">.</span><span class="fu">Abs</span><span class="op">(</span>cnt <span class="op">-</span> estimateCount<span class="op">)/</span>cnt<span class="op">*</span><span class="fl">100.0</span><span class="op">);</span></span>
<span id="testCode-21"><a href="#testCode-21" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>При k=10 получается такая таблица (стандартная ошибка \( \frac { 1.04 }{ \sqrt { { 2 }^{ 10 } } } = 3.25\)%):</p>
<table>
<thead>
<tr>
<th style="text-align: right;">Разных значений</th>
<th style="text-align: right;">Оценка</th>
<th style="text-align: center;">Ошибка,%</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: right;">10</td>
<td style="text-align: right;">10,05</td>
<td style="text-align: center;">0,4915</td>
</tr>
<tr>
<td style="text-align: right;">50</td>
<td style="text-align: right;">51,26</td>
<td style="text-align: center;">2,5239</td>
</tr>
<tr>
<td style="text-align: right;">100</td>
<td style="text-align: right;">104,12</td>
<td style="text-align: center;">4,1183</td>
</tr>
<tr>
<td style="text-align: right;">500</td>
<td style="text-align: right;">502,30</td>
<td style="text-align: center;">0,4596</td>
</tr>
<tr>
<td style="text-align: right;">1000</td>
<td style="text-align: right;">993,76</td>
<td style="text-align: center;">0,6242</td>
</tr>
<tr>
<td style="text-align: right;">5000</td>
<td style="text-align: right;">4934,58</td>
<td style="text-align: center;">1,3083</td>
</tr>
<tr>
<td style="text-align: right;">10000</td>
<td style="text-align: right;">9654,82</td>
<td style="text-align: center;">3,4518</td>
</tr>
<tr>
<td style="text-align: right;">50000</td>
<td style="text-align: right;">50896,97</td>
<td style="text-align: center;">1,7939</td>
</tr>
<tr>
<td style="text-align: right;">100000</td>
<td style="text-align: right;">101884,92</td>
<td style="text-align: center;">1,8849</td>
</tr>
<tr>
<td style="text-align: right;">500000</td>
<td style="text-align: right;">509183,34</td>
<td style="text-align: center;">1,8367</td>
</tr>
<tr>
<td style="text-align: right;">1000000</td>
<td style="text-align: right;">1023285,78</td>
<td style="text-align: center;">2,3286</td>
</tr>
<tr>
<td style="text-align: right;">5000000</td>
<td style="text-align: right;">4934955,44</td>
<td style="text-align: center;">1,3009</td>
</tr>
<tr>
<td style="text-align: right;">10000000</td>
<td style="text-align: right;">10073259,12</td>
<td style="text-align: center;">0,7326</td>
</tr>
<tr>
<td style="text-align: right;">50000000</td>
<td style="text-align: right;">49928262,24</td>
<td style="text-align: center;">0,1435</td>
</tr>
<tr>
<td style="text-align: right;">100000000</td>
<td style="text-align: right;">97500823,59</td>
<td style="text-align: center;">2,4992</td>
</tr>
</tbody>
</table>
<p>При k=16 получается такая таблица (стандартная ошибка \( \frac { 1.04 }{ \sqrt { { 2 }^{ 16 } } } = 0.40625\)%):</p>
<table>
<thead>
<tr>
<th style="text-align: right;">Разных значений</th>
<th style="text-align: right;">Оценка</th>
<th style="text-align: center;">Ошибка,%</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: right;">10</td>
<td style="text-align: right;">10,00</td>
<td style="text-align: center;">0,0076</td>
</tr>
<tr>
<td style="text-align: right;">50</td>
<td style="text-align: right;">50,02</td>
<td style="text-align: center;">0,0382</td>
</tr>
<tr>
<td style="text-align: right;">100</td>
<td style="text-align: right;">100,08</td>
<td style="text-align: center;">0,0764</td>
</tr>
<tr>
<td style="text-align: right;">500</td>
<td style="text-align: right;">501,92</td>
<td style="text-align: center;">0,3834</td>
</tr>
<tr>
<td style="text-align: right;">1000</td>
<td style="text-align: right;">1002,63</td>
<td style="text-align: center;">0,2631</td>
</tr>
<tr>
<td style="text-align: right;">5000</td>
<td style="text-align: right;">5010,77</td>
<td style="text-align: center;">0,2153</td>
</tr>
<tr>
<td style="text-align: right;">10000</td>
<td style="text-align: right;">10027,46</td>
<td style="text-align: center;">0,2746</td>
</tr>
<tr>
<td style="text-align: right;">50000</td>
<td style="text-align: right;">50124,56</td>
<td style="text-align: center;">0,2491</td>
</tr>
<tr>
<td style="text-align: right;">100000</td>
<td style="text-align: right;">99690,22</td>
<td style="text-align: center;">0,3098</td>
</tr>
<tr>
<td style="text-align: right;">500000</td>
<td style="text-align: right;">502979,77</td>
<td style="text-align: center;">0,5960</td>
</tr>
<tr>
<td style="text-align: right;">1000000</td>
<td style="text-align: right;">997461,99</td>
<td style="text-align: center;">0,2538</td>
</tr>
<tr>
<td style="text-align: right;">5000000</td>
<td style="text-align: right;">4984715,12</td>
<td style="text-align: center;">0,3057</td>
</tr>
<tr>
<td style="text-align: right;">10000000</td>
<td style="text-align: right;">9982520,07</td>
<td style="text-align: center;">0,1748</td>
</tr>
<tr>
<td style="text-align: right;">50000000</td>
<td style="text-align: right;">50020851,75</td>
<td style="text-align: center;">0,0417</td>
</tr>
<tr>
<td style="text-align: right;">100000000</td>
<td style="text-align: right;">100022493,99</td>
<td style="text-align: center;">0,0225</td>
</tr>
</tbody>
</table>
<p>Как видим ошибки оценок довольно неплохо укладываются в теорию. Теперь можно взять какой-нибудь набор данных и выбрать хеш-функцию для него.</p>
<h2 id="выбираем-функцию-хеширования">Выбираем функцию хеширования</h2>
<p>Как выше было сказано в описании, выбору хеш-функции следует уделить особое внимание по нескольким причинам:</p>
<ol type="1">
<li>Если хеш-функция выдает не достаточно случайные хеши для начальных данных, вычисленная оценка будет скорее всего очень сильно занижать реальное значение так, что
погрешность может достигать почти 100% делая вычисления бессмысленными.</li>
<li>Если статистика собирается на длительном промежутке времени, нельзя будет на ходу просто поменять хеш-функцию на другую более хорошую, т.к. иначе
уже собранную статистику придется сбросить в ноль.</li>
</ol>
<p>Для начала опробуем хеш-функцию <a href="https://ru.wikipedia.org/wiki/FNV">FNV-1a</a> на 32-битных целых числах.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode cs"><code class="sourceCode cs"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="kw">static</span> <span class="dt">int</span> <span class="fu">Fnv1AHash</span><span class="op">(</span><span class="dt">byte</span><span class="op">[]</span> bytes<span class="op">)</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">unchecked</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>        <span class="dt">const</span> <span class="dt">int</span> fnv32Offset <span class="op">=</span> <span class="op">(</span><span class="dt">int</span><span class="op">)</span><span class="dv">2166136261</span><span class="op">;</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>        <span class="dt">const</span> <span class="dt">int</span> fnv32Prime <span class="op">=</span> <span class="dv">16777619</span><span class="op">;</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>        <span class="dt">int</span> hash <span class="op">=</span> fnv32Offset<span class="op">;</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>        <span class="kw">foreach</span> <span class="op">(</span><span class="dt">var</span> t <span class="kw">in</span> bytes<span class="op">)</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>            hash <span class="op">=</span> hash <span class="op">^</span> t<span class="op">;</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>            hash <span class="op">*=</span> fnv32Prime<span class="op">;</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> hash<span class="op">;</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>Тепер для чисел целых 32-битных чисел начиная с 0 применим эту хеш-функцию. В <a href="#testCode">коде</a>, который мы применяли для тестирования
алгоритма на случайных числах заменим строку:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode cs"><code class="sourceCode cs"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="kw">foreach</span> <span class="op">(</span><span class="dt">var</span> hash <span class="kw">in</span> <span class="fu">GetRandomInts</span><span class="op">().</span><span class="fu">Take</span><span class="op">(</span><span class="dv">100000000</span><span class="op">))</span></span></code></pre></div>
<p>на</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode cs"><code class="sourceCode cs"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="kw">foreach</span> <span class="op">(</span><span class="dt">var</span> hash <span class="kw">in</span> Enumerable</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>                        <span class="op">.</span><span class="fu">Range</span><span class="op">(</span><span class="dv">0</span><span class="op">,</span> <span class="dv">100000000</span><span class="op">)</span>           <span class="co">// все целые числа, начиная с нуля в количестве 100000000</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>                        <span class="op">.</span><span class="fu">Select</span><span class="op">(</span>BitConverter<span class="op">.</span><span class="fu">GetBytes</span><span class="op">)</span> <span class="co">// конвертируем в массив из 4-х байтов</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>                        <span class="op">.</span><span class="fu">Select</span><span class="op">(</span>Fnv1AHash<span class="op">))</span>            <span class="co">// применим к каждому массиву хеш-функцию</span></span></code></pre></div>
<p>При k=10 получим такие результаты:</p>
<table>
<thead>
<tr>
<th style="text-align: right;">Разных значений</th>
<th style="text-align: right;">Оценка</th>
<th style="text-align: center;">Ошибка,%</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: right;">10</td>
<td style="text-align: right;">10,05</td>
<td style="text-align: center;">0,4915</td>
</tr>
<tr>
<td style="text-align: right;">50</td>
<td style="text-align: right;">51,26</td>
<td style="text-align: center;">2,5239</td>
</tr>
<tr>
<td style="text-align: right;">100</td>
<td style="text-align: right;">105,23</td>
<td style="text-align: center;">5,2260</td>
</tr>
<tr>
<td style="text-align: right;">500</td>
<td style="text-align: right;">549,08</td>
<td style="text-align: center;">9,8159</td>
</tr>
<tr>
<td style="text-align: right;">1000</td>
<td style="text-align: right;">1056,33</td>
<td style="text-align: center;">5,6332</td>
</tr>
<tr>
<td style="text-align: right;">5000</td>
<td style="text-align: right;">6634,90</td>
<td style="text-align: center;">32,6980</td>
</tr>
<tr>
<td style="text-align: right;">10000</td>
<td style="text-align: right;">11027,98</td>
<td style="text-align: center;">10,2798</td>
</tr>
<tr>
<td style="text-align: right;">50000</td>
<td style="text-align: right;">41923,40</td>
<td style="text-align: center;">16,1532</td>
</tr>
<tr>
<td style="text-align: right;">100000</td>
<td style="text-align: right;">54234,00</td>
<td style="text-align: center;">45,7660</td>
</tr>
<tr>
<td style="text-align: right;">500000</td>
<td style="text-align: right;">126984,56</td>
<td style="text-align: center;">74,6031</td>
</tr>
<tr>
<td style="text-align: right;">1000000</td>
<td style="text-align: right;">353391,49</td>
<td style="text-align: center;">64,6609</td>
</tr>
<tr>
<td style="text-align: right;">5000000</td>
<td style="text-align: right;">6233096,62</td>
<td style="text-align: center;">24,6619</td>
</tr>
<tr>
<td style="text-align: right;">10000000</td>
<td style="text-align: right;">13254027,76</td>
<td style="text-align: center;">32,5403</td>
</tr>
<tr>
<td style="text-align: right;">50000000</td>
<td style="text-align: right;">51887411,47</td>
<td style="text-align: center;">3,7748</td>
</tr>
<tr>
<td style="text-align: right;">100000000</td>
<td style="text-align: right;">81864421,81</td>
<td style="text-align: center;">18,1356</td>
</tr>
</tbody>
</table>
<p>Как видим, хеш-функция для наших входных данных (последовательности целых чисел начиная с нуля) не достаточно хороша, т.к. ошибка очень большая получается.
Что можно сделать? Можно попробовать сделать два раунда хеширования - сначала хешируем входные данные, затем хешируем полученный хеш:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode cs"><code class="sourceCode cs"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="kw">foreach</span> <span class="op">(</span><span class="dt">var</span> hash <span class="kw">in</span> Enumerable</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>                        <span class="op">.</span><span class="fu">Range</span><span class="op">(</span><span class="dv">0</span><span class="op">,</span> <span class="dv">100000000</span><span class="op">)</span>           <span class="co">// все целые числа, начиная с нуля в количестве 100000000</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>                        <span class="op">.</span><span class="fu">Select</span><span class="op">(</span>BitConverter<span class="op">.</span><span class="fu">GetBytes</span><span class="op">)</span> <span class="co">// конвертируем в массив из 4-х байтов</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>                        <span class="op">.</span><span class="fu">Select</span><span class="op">(</span>Fnv1AHash<span class="op">)</span>             <span class="co">// применим к каждому массиву хеш-функцию</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>                        <span class="op">.</span><span class="fu">Select</span><span class="op">(</span>BitConverter<span class="op">.</span><span class="fu">GetBytes</span><span class="op">)</span> <span class="co">// конвертируем каждый хеш в массив из 4-х байтов</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>                        <span class="op">.</span><span class="fu">Select</span><span class="op">(</span>Fnv1AHash<span class="op">))</span>            <span class="co">// применим к каждому массиву снова хеш-функцию</span></span></code></pre></div>
<p>Теперь при k=10 результаты заметно улучшились:</p>
<table>
<thead>
<tr>
<th style="text-align: right;">Разных значений</th>
<th style="text-align: right;">Оценка</th>
<th style="text-align: center;">Ошибка,%</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: right;">10</td>
<td style="text-align: right;">10,05</td>
<td style="text-align: center;">0,4915</td>
</tr>
<tr>
<td style="text-align: right;">50</td>
<td style="text-align: right;">50,21</td>
<td style="text-align: center;">0,4223</td>
</tr>
<tr>
<td style="text-align: right;">100</td>
<td style="text-align: right;">100,80</td>
<td style="text-align: center;">0,8026</td>
</tr>
<tr>
<td style="text-align: right;">500</td>
<td style="text-align: right;">486,10</td>
<td style="text-align: center;">2,7810</td>
</tr>
<tr>
<td style="text-align: right;">1000</td>
<td style="text-align: right;">967,70</td>
<td style="text-align: center;">3,2300</td>
</tr>
<tr>
<td style="text-align: right;">5000</td>
<td style="text-align: right;">4899,62</td>
<td style="text-align: center;">2,0076</td>
</tr>
<tr>
<td style="text-align: right;">10000</td>
<td style="text-align: right;">9788,63</td>
<td style="text-align: center;">2,1137</td>
</tr>
<tr>
<td style="text-align: right;">50000</td>
<td style="text-align: right;">47822,37</td>
<td style="text-align: center;">4,3553</td>
</tr>
<tr>
<td style="text-align: right;">100000</td>
<td style="text-align: right;">97091,62</td>
<td style="text-align: center;">2,9084</td>
</tr>
<tr>
<td style="text-align: right;">500000</td>
<td style="text-align: right;">474394,98</td>
<td style="text-align: center;">5,1210</td>
</tr>
<tr>
<td style="text-align: right;">1000000</td>
<td style="text-align: right;">974288,21</td>
<td style="text-align: center;">2,5712</td>
</tr>
<tr>
<td style="text-align: right;">5000000</td>
<td style="text-align: right;">5439552,49</td>
<td style="text-align: center;">8,7910</td>
</tr>
<tr>
<td style="text-align: right;">10000000</td>
<td style="text-align: right;">9955849,45</td>
<td style="text-align: center;">0,4415</td>
</tr>
<tr>
<td style="text-align: right;">50000000</td>
<td style="text-align: right;">49659117,73</td>
<td style="text-align: center;">0,6818</td>
</tr>
<tr>
<td style="text-align: right;">100000000</td>
<td style="text-align: right;">94593348,50</td>
<td style="text-align: center;">5,4067</td>
</tr>
</tbody>
</table>
<p>Многие эксперименты показывают, что <a href="http://en.wikipedia.org/wiki/MurmurHash">MurmurHash3</a> хоть и не является криптографически-безопасной хеш-функцией,
но обладает хорошим распределением, обладает высокой скоростью и устойчивостью к коллизиям. За основу была взята <a href="https://gist.github.com/automatonic/3725443">эта реализация</a>
и немного <a href="#MurmurHash3">допилена напильником</a>.</p>
<p>После замены</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode cs"><code class="sourceCode cs"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="kw">foreach</span> <span class="op">(</span><span class="dt">var</span> hash <span class="kw">in</span> Enumerable</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>                        <span class="op">.</span><span class="fu">Range</span><span class="op">(</span><span class="dv">0</span><span class="op">,</span> <span class="dv">100000000</span><span class="op">)</span>           <span class="co">// все целые числа, начиная с нуля в количестве 100000000</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>                        <span class="op">.</span><span class="fu">Select</span><span class="op">(</span>BitConverter<span class="op">.</span><span class="fu">GetBytes</span><span class="op">)</span> <span class="co">// конвертируем в массив из 4-х байтов</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>                        <span class="op">.</span><span class="fu">Select</span><span class="op">(</span>MurMurHash3<span class="op">.</span><span class="fu">Hash</span><span class="op">))</span>     <span class="co">// применим к каждому массиву хеш-функцию</span></span></code></pre></div>
<p>были полученные такие результаты при k=10:</p>
<table>
<thead>
<tr>
<th style="text-align: right;">Разных значений</th>
<th style="text-align: right;">Оценка</th>
<th style="text-align: center;">Ошибка,%</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: right;">10</td>
<td style="text-align: right;">10,05</td>
<td style="text-align: center;">0,4915</td>
</tr>
<tr>
<td style="text-align: right;">50</td>
<td style="text-align: right;">51,26</td>
<td style="text-align: center;">2,5239</td>
</tr>
<tr>
<td style="text-align: right;">100</td>
<td style="text-align: right;">101,91</td>
<td style="text-align: center;">1,9067</td>
</tr>
<tr>
<td style="text-align: right;">500</td>
<td style="text-align: right;">499,04</td>
<td style="text-align: center;">0,1927</td>
</tr>
<tr>
<td style="text-align: right;">1000</td>
<td style="text-align: right;">1001,71</td>
<td style="text-align: center;">0,1706</td>
</tr>
<tr>
<td style="text-align: right;">5000</td>
<td style="text-align: right;">5101,16</td>
<td style="text-align: center;">2,0233</td>
</tr>
<tr>
<td style="text-align: right;">10000</td>
<td style="text-align: right;">9625,14</td>
<td style="text-align: center;">3,7486</td>
</tr>
<tr>
<td style="text-align: right;">50000</td>
<td style="text-align: right;">51753,74</td>
<td style="text-align: center;">3,5075</td>
</tr>
<tr>
<td style="text-align: right;">100000</td>
<td style="text-align: right;">98546,11</td>
<td style="text-align: center;">1,4539</td>
</tr>
<tr>
<td style="text-align: right;">500000</td>
<td style="text-align: right;">487898,62</td>
<td style="text-align: center;">2,4203</td>
</tr>
<tr>
<td style="text-align: right;">1000000</td>
<td style="text-align: right;">984749,69</td>
<td style="text-align: center;">1,5250</td>
</tr>
<tr>
<td style="text-align: right;">5000000</td>
<td style="text-align: right;">5078692,01</td>
<td style="text-align: center;">1,5738</td>
</tr>
<tr>
<td style="text-align: right;">10000000</td>
<td style="text-align: right;">10075100,60</td>
<td style="text-align: center;">0,7510</td>
</tr>
<tr>
<td style="text-align: right;">50000000</td>
<td style="text-align: right;">51533442,86</td>
<td style="text-align: center;">3,0669</td>
</tr>
<tr>
<td style="text-align: right;">100000000</td>
<td style="text-align: right;">101786556,87</td>
<td style="text-align: center;">1,7866</td>
</tr>
</tbody>
</table>
<p>При k=16:</p>
<table>
<thead>
<tr>
<th style="text-align: right;">Разных значений</th>
<th style="text-align: right;">Оценка</th>
<th style="text-align: center;">Ошибка,%</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: right;">10</td>
<td style="text-align: right;">10,00</td>
<td style="text-align: center;">0,0076</td>
</tr>
<tr>
<td style="text-align: right;">50</td>
<td style="text-align: right;">50,02</td>
<td style="text-align: center;">0,0382</td>
</tr>
<tr>
<td style="text-align: right;">100</td>
<td style="text-align: right;">100,08</td>
<td style="text-align: center;">0,0764</td>
</tr>
<tr>
<td style="text-align: right;">500</td>
<td style="text-align: right;">497,89</td>
<td style="text-align: center;">0,4227</td>
</tr>
<tr>
<td style="text-align: right;">1000</td>
<td style="text-align: right;">998,57</td>
<td style="text-align: center;">0,1431</td>
</tr>
<tr>
<td style="text-align: right;">5000</td>
<td style="text-align: right;">4979,47</td>
<td style="text-align: center;">0,4106</td>
</tr>
<tr>
<td style="text-align: right;">10000</td>
<td style="text-align: right;">9961,07</td>
<td style="text-align: center;">0,3893</td>
</tr>
<tr>
<td style="text-align: right;">50000</td>
<td style="text-align: right;">50000,06</td>
<td style="text-align: center;">0,0001</td>
</tr>
<tr>
<td style="text-align: right;">100000</td>
<td style="text-align: right;">99580,45</td>
<td style="text-align: center;">0,4196</td>
</tr>
<tr>
<td style="text-align: right;">500000</td>
<td style="text-align: right;">497924,41</td>
<td style="text-align: center;">0,4151</td>
</tr>
<tr>
<td style="text-align: right;">1000000</td>
<td style="text-align: right;">996976,43</td>
<td style="text-align: center;">0,3024</td>
</tr>
<tr>
<td style="text-align: right;">5000000</td>
<td style="text-align: right;">5003075,05</td>
<td style="text-align: center;">0,0615</td>
</tr>
<tr>
<td style="text-align: right;">10000000</td>
<td style="text-align: right;">9991536,18</td>
<td style="text-align: center;">0,0846</td>
</tr>
<tr>
<td style="text-align: right;">50000000</td>
<td style="text-align: right;">50289746,12</td>
<td style="text-align: center;">0,5795</td>
</tr>
<tr>
<td style="text-align: right;">100000000</td>
<td style="text-align: right;">100782312,74</td>
<td style="text-align: center;">0,7823</td>
</tr>
</tbody>
</table>
<p>Таким образом MurmurHash3 оказалась действительно неплохой хеш-функцией в нашем случае.</p>
<h2 id="объединяем-результаты">Объединяем результаты</h2>
<p>Теперь наглядно убедимся, что можно объединять результаты оценки уникальных элементов. Для этого возьмем числа из интервала [0, 9999]
произведем оценку числа уникальных элементов на этом интервале, затем то же самое отдельно сделаем для интервала [5000, 14999], после чего
объединим результаты. Т.е. в итоге у нас должно получиться порядка 15000 уникальных элементов:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode cs"><code class="sourceCode cs"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> hll1 <span class="op">=</span> <span class="kw">new</span> <span class="fu">HyperLogLog</span><span class="op">(</span><span class="dv">10</span><span class="op">);</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> hll2 <span class="op">=</span> <span class="kw">new</span> <span class="fu">HyperLogLog</span><span class="op">(</span><span class="dv">10</span><span class="op">);</span> </span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="kw">foreach</span> <span class="op">(</span><span class="dt">var</span> hash <span class="kw">in</span> Enumerable</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>                    <span class="op">.</span><span class="fu">Range</span><span class="op">(</span><span class="dv">0</span><span class="op">,</span> <span class="dv">10000</span><span class="op">)</span>                <span class="co">// все целые числа, начиная с нуля в количестве 10000</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>                    <span class="op">.</span><span class="fu">Select</span><span class="op">(</span>BitConverter<span class="op">.</span><span class="fu">GetBytes</span><span class="op">)</span> <span class="co">// конвертируем в массив из 4-х байтов</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>                    <span class="op">.</span><span class="fu">Select</span><span class="op">(</span>MurMurHash3<span class="op">.</span><span class="fu">Hash</span><span class="op">))</span>     <span class="co">// применим к каждому массиву хеш-функцию                        </span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>    hll1<span class="op">.</span><span class="fu">Add</span><span class="op">(</span>hash<span class="op">);</span>     </span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a><span class="kw">foreach</span> <span class="op">(</span><span class="dt">var</span> hash <span class="kw">in</span> Enumerable</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>                    <span class="op">.</span><span class="fu">Range</span><span class="op">(</span><span class="dv">5000</span><span class="op">,</span> <span class="dv">10000</span><span class="op">)</span>            <span class="co">// все целые числа, начиная с 5000 в количестве 10000</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>                    <span class="op">.</span><span class="fu">Select</span><span class="op">(</span>BitConverter<span class="op">.</span><span class="fu">GetBytes</span><span class="op">)</span> <span class="co">// конвертируем в массив из 4-х байтов</span></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>                    <span class="op">.</span><span class="fu">Select</span><span class="op">(</span>MurMurHash3<span class="op">.</span><span class="fu">Hash</span><span class="op">))</span>     <span class="co">// применим к каждому массиву хеш-функцию                        </span></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>    hll2<span class="op">.</span><span class="fu">Add</span><span class="op">(</span>hash<span class="op">);</span>     </span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>Console<span class="op">.</span><span class="fu">WriteLine</span><span class="op">(</span><span class="st">&quot;Уникальных элементов на интервале 0-9999: {0:0.00}&quot;</span><span class="op">,</span> hll1<span class="op">.</span><span class="fu">EstimateCount</span><span class="op">());</span></span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>Console<span class="op">.</span><span class="fu">WriteLine</span><span class="op">(</span><span class="st">&quot;Уникальных элементов на интервале 5000-14999: {0:0.00}&quot;</span><span class="op">,</span> hll2<span class="op">.</span><span class="fu">EstimateCount</span><span class="op">());</span></span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>hll1<span class="op">.</span><span class="fu">UnionWith</span><span class="op">(</span>hll2<span class="op">);</span> <span class="co">// в hll1 будет объединение всех уникальных элементов</span></span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>Console<span class="op">.</span><span class="fu">WriteLine</span><span class="op">(</span><span class="st">&quot;Уникальных элементов на интервале 0-14999: {0:0.00}&quot;</span><span class="op">,</span> hll1<span class="op">.</span><span class="fu">EstimateCount</span><span class="op">());</span></span></code></pre></div>
<p>В результате получаем:</p>
<pre><code>Уникальных элементов на интервале 0-9999: 9625,14
Уникальных элементов на интервале 5000-14999: 10013,74
Уникальных элементов на интервале 0-14999: 15139,33</code></pre>
<p>Что нисколько не отличается, если бы мы произвели измерения на одном объекте:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode cs"><code class="sourceCode cs"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> hll <span class="op">=</span> <span class="kw">new</span> <span class="fu">HyperLogLog</span><span class="op">(</span><span class="dv">10</span><span class="op">);</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="kw">foreach</span> <span class="op">(</span><span class="dt">var</span> hash <span class="kw">in</span> Enumerable</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>                    <span class="op">.</span><span class="fu">Range</span><span class="op">(</span><span class="dv">0</span><span class="op">,</span> <span class="dv">15000</span><span class="op">)</span>               <span class="co">// все целые числа, начиная с нуля в количестве 15000</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>                    <span class="op">.</span><span class="fu">Select</span><span class="op">(</span>BitConverter<span class="op">.</span><span class="fu">GetBytes</span><span class="op">)</span> <span class="co">// конвертируем в массив из 4-х байтов</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>                    <span class="op">.</span><span class="fu">Select</span><span class="op">(</span>MurMurHash3<span class="op">.</span><span class="fu">Hash</span><span class="op">))</span>     <span class="co">// применим к каждому массиву хеш-функцию                        </span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>    hll<span class="op">.</span><span class="fu">Add</span><span class="op">(</span>hash<span class="op">);</span>      </span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>Console<span class="op">.</span><span class="fu">WriteLine</span><span class="op">(</span><span class="st">&quot;Уникальных элементов на интервале 0-14999: {0:0.00}&quot;</span><span class="op">,</span> hll<span class="op">.</span><span class="fu">EstimateCount</span><span class="op">());</span></span></code></pre></div>
<p>И в этом случае получили абсолютно тот же самый результат:</p>
<pre><code>Уникальных элементов на интервале 0-14999: 15139,33</code></pre>
<p>Это не должно нас удивлять, т.к. хеши одинаковых элементов совпадают до бита, и попадают в одни и те же регистры, а максимум последовательности
нулей в хешах можно искать в произвольном порядке и в результате получим одно и то же число. Это все равно что искать максимальное число в массиве -
можно поделить его на несколько частей, параллельно там найти максимумы, а потом среди максимумов найти один единственный максимум. То же самое
происходит в нашем случае на уровне отдельных регистров.</p>
<h2 id="MurmurHash3">Имплементация хеш-функции MurmurHash3 на C#</h2>
<div class="sourceCode" id="cb11"><pre class="sourceCode numberSource cs numberLines"><code class="sourceCode cs"><span id="cb11-1"><a href="#cb11-1"></a><span class="kw">public</span> <span class="kw">static</span> <span class="kw">class</span> MurMurHash3</span>
<span id="cb11-2"><a href="#cb11-2"></a><span class="op">{</span></span>
<span id="cb11-3"><a href="#cb11-3"></a>    <span class="dt">const</span> <span class="dt">uint</span> seed <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb11-4"><a href="#cb11-4"></a> </span>
<span id="cb11-5"><a href="#cb11-5"></a>    <span class="kw">public</span> <span class="kw">static</span> <span class="dt">int</span> <span class="fu">Hash</span><span class="op">(</span><span class="dt">byte</span><span class="op">[]</span> bytes<span class="op">)</span></span>
<span id="cb11-6"><a href="#cb11-6"></a>    <span class="op">{</span></span>
<span id="cb11-7"><a href="#cb11-7"></a>        <span class="kw">unchecked</span></span>
<span id="cb11-8"><a href="#cb11-8"></a>        <span class="op">{</span></span>
<span id="cb11-9"><a href="#cb11-9"></a>            <span class="dt">const</span> <span class="dt">uint</span> c1 <span class="op">=</span> <span class="bn">0xcc9e2d51</span><span class="op">;</span></span>
<span id="cb11-10"><a href="#cb11-10"></a>            <span class="dt">const</span> <span class="dt">uint</span> c2 <span class="op">=</span> <span class="bn">0x1b873593</span><span class="op">;</span></span>
<span id="cb11-11"><a href="#cb11-11"></a>    </span>
<span id="cb11-12"><a href="#cb11-12"></a>            <span class="dt">uint</span> h1 <span class="op">=</span> seed<span class="op">;</span></span>
<span id="cb11-13"><a href="#cb11-13"></a>            <span class="dt">uint</span> k1 <span class="op">=</span> <span class="dv">0</span><span class="op">;</span>        </span>
<span id="cb11-14"><a href="#cb11-14"></a>    </span>
<span id="cb11-15"><a href="#cb11-15"></a>            <span class="kw">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> bytes<span class="op">.</span><span class="fu">Length</span><span class="op">;</span> i <span class="op">=</span> i <span class="op">+</span> <span class="dv">4</span><span class="op">)</span></span>
<span id="cb11-16"><a href="#cb11-16"></a>            <span class="op">{</span></span>
<span id="cb11-17"><a href="#cb11-17"></a>                <span class="dt">var</span> chunkLength <span class="op">=</span> bytes<span class="op">.</span><span class="fu">Length</span> <span class="op">-</span> i<span class="op">;</span></span>
<span id="cb11-18"><a href="#cb11-18"></a>                <span class="kw">switch</span><span class="op">(</span>chunkLength<span class="op">)</span></span>
<span id="cb11-19"><a href="#cb11-19"></a>                <span class="op">{</span></span>
<span id="cb11-20"><a href="#cb11-20"></a>                    <span class="kw">case</span> <span class="dv">4</span><span class="op">:</span></span>
<span id="cb11-21"><a href="#cb11-21"></a>                        k1 <span class="op">=</span> <span class="op">(</span><span class="dt">uint</span><span class="op">)(</span>bytes<span class="op">[</span>i<span class="op">]</span> <span class="op">|</span> bytes<span class="op">[</span>i <span class="op">+</span> <span class="dv">1</span><span class="op">]</span> <span class="op">&lt;&lt;</span> <span class="dv">8</span> <span class="op">|</span> bytes<span class="op">[</span>i <span class="op">+</span> <span class="dv">2</span><span class="op">]</span> <span class="op">&lt;&lt;</span> <span class="dv">16</span> <span class="op">|</span> bytes<span class="op">[</span>i <span class="op">+</span> <span class="dv">3</span><span class="op">]</span> <span class="op">&lt;&lt;</span> <span class="dv">24</span><span class="op">);</span></span>
<span id="cb11-22"><a href="#cb11-22"></a>    </span>
<span id="cb11-23"><a href="#cb11-23"></a>                        k1 <span class="op">*=</span> c1<span class="op">;</span></span>
<span id="cb11-24"><a href="#cb11-24"></a>                        k1 <span class="op">=</span> <span class="fu">rotl32</span><span class="op">(</span>k1<span class="op">,</span> <span class="dv">15</span><span class="op">);</span></span>
<span id="cb11-25"><a href="#cb11-25"></a>                        k1 <span class="op">*=</span> c2<span class="op">;</span></span>
<span id="cb11-26"><a href="#cb11-26"></a>    </span>
<span id="cb11-27"><a href="#cb11-27"></a>                        h1 <span class="op">^=</span> k1<span class="op">;</span></span>
<span id="cb11-28"><a href="#cb11-28"></a>                        h1 <span class="op">=</span> <span class="fu">rotl32</span><span class="op">(</span>h1<span class="op">,</span> <span class="dv">13</span><span class="op">);</span></span>
<span id="cb11-29"><a href="#cb11-29"></a>                        h1 <span class="op">=</span> h1 <span class="op">*</span> <span class="dv">5</span> <span class="op">+</span> <span class="bn">0xe6546b64</span><span class="op">;</span></span>
<span id="cb11-30"><a href="#cb11-30"></a>                        <span class="kw">break</span><span class="op">;</span></span>
<span id="cb11-31"><a href="#cb11-31"></a>                    <span class="kw">case</span> <span class="dv">3</span><span class="op">:</span></span>
<span id="cb11-32"><a href="#cb11-32"></a>                        k1 <span class="op">=</span> <span class="op">(</span><span class="dt">uint</span><span class="op">)(</span>bytes<span class="op">[</span>i<span class="op">]</span> <span class="op">|</span> bytes<span class="op">[</span>i <span class="op">+</span> <span class="dv">1</span><span class="op">]</span> <span class="op">&lt;&lt;</span> <span class="dv">8</span> <span class="op">|</span> bytes<span class="op">[</span>i <span class="op">+</span> <span class="dv">2</span><span class="op">]</span> <span class="op">&lt;&lt;</span> <span class="dv">16</span><span class="op">);</span></span>
<span id="cb11-33"><a href="#cb11-33"></a>                        k1 <span class="op">*=</span> c1<span class="op">;</span></span>
<span id="cb11-34"><a href="#cb11-34"></a>                        k1 <span class="op">=</span> <span class="fu">rotl32</span><span class="op">(</span>k1<span class="op">,</span> <span class="dv">15</span><span class="op">);</span></span>
<span id="cb11-35"><a href="#cb11-35"></a>                        k1 <span class="op">*=</span> c2<span class="op">;</span></span>
<span id="cb11-36"><a href="#cb11-36"></a>                        h1 <span class="op">^=</span> k1<span class="op">;</span></span>
<span id="cb11-37"><a href="#cb11-37"></a>                        <span class="kw">break</span><span class="op">;</span></span>
<span id="cb11-38"><a href="#cb11-38"></a>                    <span class="kw">case</span> <span class="dv">2</span><span class="op">:</span></span>
<span id="cb11-39"><a href="#cb11-39"></a>                        k1 <span class="op">=</span> <span class="op">(</span><span class="dt">uint</span><span class="op">)</span> <span class="op">(</span>bytes<span class="op">[</span>i<span class="op">]</span> <span class="op">|</span> bytes<span class="op">[</span>i <span class="op">+</span> <span class="dv">1</span><span class="op">]</span> <span class="op">&lt;&lt;</span> <span class="dv">8</span><span class="op">);</span></span>
<span id="cb11-40"><a href="#cb11-40"></a>                        k1 <span class="op">*=</span> c1<span class="op">;</span></span>
<span id="cb11-41"><a href="#cb11-41"></a>                        k1 <span class="op">=</span> <span class="fu">rotl32</span><span class="op">(</span>k1<span class="op">,</span> <span class="dv">15</span><span class="op">);</span></span>
<span id="cb11-42"><a href="#cb11-42"></a>                        k1 <span class="op">*=</span> c2<span class="op">;</span></span>
<span id="cb11-43"><a href="#cb11-43"></a>                        h1 <span class="op">^=</span> k1<span class="op">;</span></span>
<span id="cb11-44"><a href="#cb11-44"></a>                        <span class="kw">break</span><span class="op">;</span></span>
<span id="cb11-45"><a href="#cb11-45"></a>                    <span class="kw">case</span> <span class="dv">1</span><span class="op">:</span></span>
<span id="cb11-46"><a href="#cb11-46"></a>                        k1 <span class="op">=</span> <span class="op">(</span><span class="dt">uint</span><span class="op">)(</span>bytes<span class="op">[</span>i<span class="op">]);</span></span>
<span id="cb11-47"><a href="#cb11-47"></a>                        k1 <span class="op">*=</span> c1<span class="op">;</span></span>
<span id="cb11-48"><a href="#cb11-48"></a>                        k1 <span class="op">=</span> <span class="fu">rotl32</span><span class="op">(</span>k1<span class="op">,</span> <span class="dv">15</span><span class="op">);</span></span>
<span id="cb11-49"><a href="#cb11-49"></a>                        k1 <span class="op">*=</span> c2<span class="op">;</span></span>
<span id="cb11-50"><a href="#cb11-50"></a>                        h1 <span class="op">^=</span> k1<span class="op">;</span></span>
<span id="cb11-51"><a href="#cb11-51"></a>                        <span class="kw">break</span><span class="op">;</span>              </span>
<span id="cb11-52"><a href="#cb11-52"></a>                <span class="op">}</span>           </span>
<span id="cb11-53"><a href="#cb11-53"></a>            <span class="op">}</span></span>
<span id="cb11-54"><a href="#cb11-54"></a>                    </span>
<span id="cb11-55"><a href="#cb11-55"></a>            h1 <span class="op">^=</span> <span class="op">(</span><span class="dt">uint</span><span class="op">)</span>bytes<span class="op">.</span><span class="fu">Length</span><span class="op">;</span></span>
<span id="cb11-56"><a href="#cb11-56"></a>            h1 <span class="op">=</span> <span class="fu">finalizer32</span><span class="op">(</span>h1<span class="op">);</span></span>
<span id="cb11-57"><a href="#cb11-57"></a>    </span>
<span id="cb11-58"><a href="#cb11-58"></a>            <span class="kw">return</span> <span class="op">(</span><span class="dt">int</span><span class="op">)</span>h1<span class="op">;</span>         </span>
<span id="cb11-59"><a href="#cb11-59"></a>        <span class="op">}</span></span>
<span id="cb11-60"><a href="#cb11-60"></a>    <span class="op">}</span></span>
<span id="cb11-61"><a href="#cb11-61"></a>    </span>
<span id="cb11-62"><a href="#cb11-62"></a>    <span class="kw">private</span> <span class="kw">static</span> <span class="dt">uint</span> <span class="fu">rotl32</span><span class="op">(</span><span class="dt">uint</span> x<span class="op">,</span> <span class="dt">byte</span> r<span class="op">)</span></span>
<span id="cb11-63"><a href="#cb11-63"></a>    <span class="op">{</span></span>
<span id="cb11-64"><a href="#cb11-64"></a>        <span class="kw">return</span> <span class="op">(</span>x <span class="op">&lt;&lt;</span> r<span class="op">)</span> <span class="op">|</span> <span class="op">(</span>x <span class="op">&gt;&gt;</span> <span class="op">(</span><span class="dv">32</span> <span class="op">-</span> r<span class="op">));</span></span>
<span id="cb11-65"><a href="#cb11-65"></a>    <span class="op">}</span></span>
<span id="cb11-66"><a href="#cb11-66"></a> </span>
<span id="cb11-67"><a href="#cb11-67"></a>    <span class="kw">private</span> <span class="kw">static</span> <span class="dt">uint</span> <span class="fu">finalizer32</span><span class="op">(</span><span class="dt">uint</span> h<span class="op">)</span></span>
<span id="cb11-68"><a href="#cb11-68"></a>    <span class="op">{</span></span>
<span id="cb11-69"><a href="#cb11-69"></a>        <span class="kw">unchecked</span></span>
<span id="cb11-70"><a href="#cb11-70"></a>        <span class="op">{</span></span>
<span id="cb11-71"><a href="#cb11-71"></a>            h <span class="op">^=</span> h <span class="op">&gt;&gt;</span> <span class="dv">16</span><span class="op">;</span></span>
<span id="cb11-72"><a href="#cb11-72"></a>            h <span class="op">*=</span> <span class="bn">0x85ebca6b</span><span class="op">;</span></span>
<span id="cb11-73"><a href="#cb11-73"></a>            h <span class="op">^=</span> h <span class="op">&gt;&gt;</span> <span class="dv">13</span><span class="op">;</span></span>
<span id="cb11-74"><a href="#cb11-74"></a>            h <span class="op">*=</span> <span class="bn">0xc2b2ae35</span><span class="op">;</span></span>
<span id="cb11-75"><a href="#cb11-75"></a>            h <span class="op">^=</span> h <span class="op">&gt;&gt;</span> <span class="dv">16</span><span class="op">;</span></span>
<span id="cb11-76"><a href="#cb11-76"></a>            <span class="kw">return</span> h<span class="op">;</span>           </span>
<span id="cb11-77"><a href="#cb11-77"></a>        <span class="op">}</span></span>
<span id="cb11-78"><a href="#cb11-78"></a>    <span class="op">}</span></span>
<span id="cb11-79"><a href="#cb11-79"></a><span class="op">}</span></span></code></pre></div>
<h2 id="HyperLogLogCode">Имплементация алгоритма HyperLogLog на C#</h2>
<div class="sourceCode" id="cb12"><pre class="sourceCode numberSource cs numberLines"><code class="sourceCode cs"><span id="cb12-1"><a href="#cb12-1"></a><span class="kw">public</span> <span class="kw">sealed</span> <span class="kw">class</span> HyperLogLog</span>
<span id="cb12-2"><a href="#cb12-2"></a><span class="op">{</span></span>
<span id="cb12-3"><a href="#cb12-3"></a>    <span class="dt">const</span> <span class="dt">double</span> TwoPowOf32 <span class="op">=</span> <span class="bn">0x100000000</span><span class="op">;</span></span>
<span id="cb12-4"><a href="#cb12-4"></a></span>
<span id="cb12-5"><a href="#cb12-5"></a>    <span class="kw">private</span> <span class="kw">readonly</span> <span class="dt">int</span> _kComplement<span class="op">;</span></span>
<span id="cb12-6"><a href="#cb12-6"></a>    <span class="kw">private</span> <span class="kw">readonly</span> <span class="dt">int</span> _m<span class="op">;</span></span>
<span id="cb12-7"><a href="#cb12-7"></a>    <span class="kw">private</span> <span class="kw">readonly</span> <span class="dt">double</span> _alphaM2<span class="op">;</span></span>
<span id="cb12-8"><a href="#cb12-8"></a>    <span class="kw">private</span> <span class="kw">readonly</span> <span class="dt">byte</span><span class="op">[]</span> _registerM<span class="op">;</span></span>
<span id="cb12-9"><a href="#cb12-9"></a></span>
<span id="cb12-10"><a href="#cb12-10"></a>    <span class="kw">public</span> <span class="fu">HyperLogLog</span><span class="op">(</span><span class="dt">int</span> k<span class="op">)</span></span>
<span id="cb12-11"><a href="#cb12-11"></a>    <span class="op">{</span></span>
<span id="cb12-12"><a href="#cb12-12"></a>        <span class="kw">if</span> <span class="op">(</span>k <span class="op">&lt;</span> <span class="dv">4</span> <span class="op">||</span> k <span class="op">&gt;</span> <span class="dv">16</span><span class="op">)</span></span>
<span id="cb12-13"><a href="#cb12-13"></a>        <span class="op">{</span></span>
<span id="cb12-14"><a href="#cb12-14"></a>            <span class="kw">throw</span> <span class="kw">new</span> <span class="fu">ArgumentOutOfRangeException</span><span class="op">(</span><span class="st">&quot;k&quot;</span><span class="op">,</span> k<span class="op">,</span> <span class="st">&quot;k must be between 4 and 16 inclusive&quot;</span><span class="op">);</span></span>
<span id="cb12-15"><a href="#cb12-15"></a>        <span class="op">}</span></span>
<span id="cb12-16"><a href="#cb12-16"></a></span>
<span id="cb12-17"><a href="#cb12-17"></a>        _kComplement <span class="op">=</span> <span class="dv">32</span> <span class="op">-</span> k<span class="op">;</span></span>
<span id="cb12-18"><a href="#cb12-18"></a>        _m <span class="op">=</span> <span class="dv">1</span> <span class="op">&lt;&lt;</span> k<span class="op">;</span></span>
<span id="cb12-19"><a href="#cb12-19"></a>        <span class="dt">var</span> alphaM <span class="op">=</span> _m <span class="op">==</span> <span class="dv">16</span></span>
<span id="cb12-20"><a href="#cb12-20"></a>            <span class="op">?</span> <span class="fl">0.673</span></span>
<span id="cb12-21"><a href="#cb12-21"></a>            <span class="op">:</span> _m <span class="op">==</span> <span class="dv">32</span></span>
<span id="cb12-22"><a href="#cb12-22"></a>                <span class="op">?</span> <span class="fl">0.697</span></span>
<span id="cb12-23"><a href="#cb12-23"></a>                <span class="op">:</span> _m <span class="op">==</span> <span class="dv">64</span></span>
<span id="cb12-24"><a href="#cb12-24"></a>                    <span class="op">?</span> <span class="fl">0.709</span></span>
<span id="cb12-25"><a href="#cb12-25"></a>                    <span class="op">:</span> <span class="fl">0.7213</span><span class="op">/(</span><span class="fl">1.0</span> <span class="op">+</span> <span class="fl">1.079</span><span class="op">/</span>_m<span class="op">);</span></span>
<span id="cb12-26"><a href="#cb12-26"></a>        _alphaM2 <span class="op">=</span> alphaM <span class="op">*</span> _m <span class="op">*</span> _m<span class="op">;</span></span>
<span id="cb12-27"><a href="#cb12-27"></a>        _registerM <span class="op">=</span> <span class="kw">new</span> <span class="dt">byte</span><span class="op">[</span>_m<span class="op">];</span></span>
<span id="cb12-28"><a href="#cb12-28"></a>    <span class="op">}</span></span>
<span id="cb12-29"><a href="#cb12-29"></a></span>
<span id="cb12-30"><a href="#cb12-30"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">Add</span><span class="op">(</span><span class="dt">int</span> hash<span class="op">)</span></span>
<span id="cb12-31"><a href="#cb12-31"></a>    <span class="op">{</span></span>
<span id="cb12-32"><a href="#cb12-32"></a>        <span class="dt">var</span> idx <span class="op">=</span> <span class="op">(</span><span class="dt">uint</span><span class="op">)</span> hash <span class="op">&gt;&gt;</span> _kComplement<span class="op">;</span></span>
<span id="cb12-33"><a href="#cb12-33"></a>        <span class="dt">var</span> rank <span class="op">=</span> Math<span class="op">.</span><span class="fu">Min</span><span class="op">(</span>_kComplement<span class="op">,</span> <span class="fu">CountTrailingZeroBits</span><span class="op">(</span>hash<span class="op">))</span> <span class="op">+</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb12-34"><a href="#cb12-34"></a>        _registerM<span class="op">[</span>idx<span class="op">]</span> <span class="op">=</span> <span class="op">(</span><span class="dt">byte</span><span class="op">)</span> Math<span class="op">.</span><span class="fu">Max</span><span class="op">(</span>_registerM<span class="op">[</span>idx<span class="op">],</span> rank<span class="op">);</span></span>
<span id="cb12-35"><a href="#cb12-35"></a>    <span class="op">}</span></span>
<span id="cb12-36"><a href="#cb12-36"></a></span>
<span id="cb12-37"><a href="#cb12-37"></a>    <span class="kw">public</span> <span class="dt">double</span> <span class="fu">EstimateCount</span><span class="op">()</span></span>
<span id="cb12-38"><a href="#cb12-38"></a>    <span class="op">{</span></span>
<span id="cb12-39"><a href="#cb12-39"></a>        <span class="dt">double</span> c <span class="op">=</span> <span class="fl">0.0</span><span class="op">;</span></span>
<span id="cb12-40"><a href="#cb12-40"></a>        <span class="kw">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> _m<span class="op">;</span> i<span class="op">++)</span></span>
<span id="cb12-41"><a href="#cb12-41"></a>        <span class="op">{</span></span>
<span id="cb12-42"><a href="#cb12-42"></a>            c <span class="op">+=</span> <span class="fl">1.0</span> <span class="op">/</span> Math<span class="op">.</span><span class="fu">Pow</span><span class="op">(</span><span class="dv">2</span><span class="op">,</span> _registerM<span class="op">[</span>i<span class="op">]);</span></span>
<span id="cb12-43"><a href="#cb12-43"></a>        <span class="op">}</span></span>
<span id="cb12-44"><a href="#cb12-44"></a></span>
<span id="cb12-45"><a href="#cb12-45"></a>        <span class="dt">double</span> estimate <span class="op">=</span> _alphaM2 <span class="op">/</span> c<span class="op">;</span></span>
<span id="cb12-46"><a href="#cb12-46"></a></span>
<span id="cb12-47"><a href="#cb12-47"></a>        <span class="kw">if</span> <span class="op">(</span>estimate <span class="op">&lt;=</span> <span class="op">(</span><span class="fl">2.5</span> <span class="op">*</span> _m<span class="op">))</span></span>
<span id="cb12-48"><a href="#cb12-48"></a>        <span class="op">{</span></span>
<span id="cb12-49"><a href="#cb12-49"></a>            <span class="dt">int</span> v <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb12-50"><a href="#cb12-50"></a>            <span class="kw">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> _m<span class="op">;</span> i<span class="op">++)</span></span>
<span id="cb12-51"><a href="#cb12-51"></a>            <span class="op">{</span></span>
<span id="cb12-52"><a href="#cb12-52"></a>                <span class="kw">if</span> <span class="op">(</span>_registerM<span class="op">[</span>i<span class="op">]</span> <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span> v<span class="op">++;</span> <span class="op">}</span></span>
<span id="cb12-53"><a href="#cb12-53"></a>            <span class="op">}</span></span>
<span id="cb12-54"><a href="#cb12-54"></a></span>
<span id="cb12-55"><a href="#cb12-55"></a>            <span class="kw">if</span> <span class="op">(</span>v <span class="op">&gt;</span> <span class="dv">0</span><span class="op">)</span></span>
<span id="cb12-56"><a href="#cb12-56"></a>            <span class="op">{</span></span>
<span id="cb12-57"><a href="#cb12-57"></a>                estimate <span class="op">=</span> _m <span class="op">*</span> Math<span class="op">.</span><span class="fu">Log</span><span class="op">((</span><span class="dt">double</span><span class="op">)</span>_m <span class="op">/</span> v<span class="op">);</span></span>
<span id="cb12-58"><a href="#cb12-58"></a>            <span class="op">}</span></span>
<span id="cb12-59"><a href="#cb12-59"></a>        <span class="op">}</span></span>
<span id="cb12-60"><a href="#cb12-60"></a>        <span class="kw">else</span> <span class="kw">if</span> <span class="op">(</span>estimate <span class="op">&gt;</span> <span class="op">(</span>TwoPowOf32 <span class="op">/</span> <span class="fl">30.0</span><span class="op">))</span></span>
<span id="cb12-61"><a href="#cb12-61"></a>        <span class="op">{</span></span>
<span id="cb12-62"><a href="#cb12-62"></a>            estimate <span class="op">=</span> <span class="op">-</span>TwoPowOf32 <span class="op">*</span> Math<span class="op">.</span><span class="fu">Log</span><span class="op">(</span><span class="fl">1.0</span> <span class="op">-</span> <span class="op">(</span>estimate <span class="op">/</span> TwoPowOf32<span class="op">));</span></span>
<span id="cb12-63"><a href="#cb12-63"></a>        <span class="op">}</span></span>
<span id="cb12-64"><a href="#cb12-64"></a></span>
<span id="cb12-65"><a href="#cb12-65"></a>        <span class="kw">return</span> estimate<span class="op">;</span></span>
<span id="cb12-66"><a href="#cb12-66"></a>    <span class="op">}</span></span>
<span id="cb12-67"><a href="#cb12-67"></a></span>
<span id="cb12-68"><a href="#cb12-68"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">UnionWith</span><span class="op">(</span>HyperLogLog other<span class="op">)</span></span>
<span id="cb12-69"><a href="#cb12-69"></a>    <span class="op">{</span></span>
<span id="cb12-70"><a href="#cb12-70"></a>        <span class="kw">if</span> <span class="op">(</span>other <span class="op">==</span> <span class="kw">null</span><span class="op">)</span></span>
<span id="cb12-71"><a href="#cb12-71"></a>        <span class="op">{</span></span>
<span id="cb12-72"><a href="#cb12-72"></a>            <span class="kw">throw</span> <span class="kw">new</span> <span class="fu">ArgumentNullException</span><span class="op">(</span><span class="st">&quot;other&quot;</span><span class="op">);</span></span>
<span id="cb12-73"><a href="#cb12-73"></a>        <span class="op">}</span></span>
<span id="cb12-74"><a href="#cb12-74"></a></span>
<span id="cb12-75"><a href="#cb12-75"></a>        <span class="kw">if</span> <span class="op">(</span>other<span class="op">.</span><span class="fu">_m</span> <span class="op">!=</span> _m<span class="op">)</span></span>
<span id="cb12-76"><a href="#cb12-76"></a>        <span class="op">{</span></span>
<span id="cb12-77"><a href="#cb12-77"></a>            <span class="kw">throw</span> <span class="kw">new</span> <span class="fu">InvalidOperationException</span><span class="op">(</span><span class="st">&quot;The number of counters must be the same.&quot;</span><span class="op">);</span></span>
<span id="cb12-78"><a href="#cb12-78"></a>        <span class="op">}</span></span>
<span id="cb12-79"><a href="#cb12-79"></a></span>
<span id="cb12-80"><a href="#cb12-80"></a>        <span class="kw">if</span> <span class="op">(</span>other <span class="op">==</span> <span class="kw">this</span><span class="op">)</span></span>
<span id="cb12-81"><a href="#cb12-81"></a>        <span class="op">{</span></span>
<span id="cb12-82"><a href="#cb12-82"></a>            <span class="kw">return</span><span class="op">;</span></span>
<span id="cb12-83"><a href="#cb12-83"></a>        <span class="op">}</span></span>
<span id="cb12-84"><a href="#cb12-84"></a></span>
<span id="cb12-85"><a href="#cb12-85"></a>        <span class="kw">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> _m<span class="op">;</span> i<span class="op">++)</span></span>
<span id="cb12-86"><a href="#cb12-86"></a>        <span class="op">{</span></span>
<span id="cb12-87"><a href="#cb12-87"></a>            _registerM<span class="op">[</span>i<span class="op">]</span> <span class="op">=</span> Math<span class="op">.</span><span class="fu">Max</span><span class="op">(</span>_registerM<span class="op">[</span>i<span class="op">],</span> other<span class="op">.</span><span class="fu">_registerM</span><span class="op">[</span>i<span class="op">]);</span></span>
<span id="cb12-88"><a href="#cb12-88"></a>        <span class="op">}</span></span>
<span id="cb12-89"><a href="#cb12-89"></a>    <span class="op">}</span></span>
<span id="cb12-90"><a href="#cb12-90"></a></span>
<span id="cb12-91"><a href="#cb12-91"></a>    <span class="kw">private</span> <span class="kw">static</span> <span class="dt">int</span> <span class="fu">CountTrailingZeroBits</span><span class="op">(</span><span class="dt">int</span> v<span class="op">)</span></span>
<span id="cb12-92"><a href="#cb12-92"></a>    <span class="op">{</span></span>
<span id="cb12-93"><a href="#cb12-93"></a>        <span class="kw">if</span> <span class="op">((</span>v <span class="op">&amp;</span> <span class="bn">0x1</span><span class="op">)</span> <span class="op">==</span> <span class="dv">1</span><span class="op">)</span> <span class="op">{</span> <span class="kw">return</span> <span class="dv">0</span><span class="op">;</span> <span class="op">}</span></span>
<span id="cb12-94"><a href="#cb12-94"></a>        </span>
<span id="cb12-95"><a href="#cb12-95"></a>        <span class="dt">int</span> c <span class="op">=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb12-96"><a href="#cb12-96"></a>        <span class="kw">if</span> <span class="op">((</span>v <span class="op">&amp;</span> <span class="bn">0xffff</span><span class="op">)</span> <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span> v <span class="op">&gt;&gt;=</span> <span class="dv">16</span><span class="op">;</span> c <span class="op">+=</span> <span class="dv">16</span><span class="op">;</span> <span class="op">}</span></span>
<span id="cb12-97"><a href="#cb12-97"></a>        <span class="kw">if</span> <span class="op">((</span>v <span class="op">&amp;</span> <span class="bn">0xff</span><span class="op">)</span> <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span> v <span class="op">&gt;&gt;=</span> <span class="dv">8</span><span class="op">;</span> c <span class="op">+=</span> <span class="dv">8</span><span class="op">;</span> <span class="op">}</span></span>
<span id="cb12-98"><a href="#cb12-98"></a>        <span class="kw">if</span> <span class="op">((</span>v <span class="op">&amp;</span> <span class="bn">0xf</span><span class="op">)</span> <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span> v <span class="op">&gt;&gt;=</span> <span class="dv">4</span><span class="op">;</span> c <span class="op">+=</span> <span class="dv">4</span><span class="op">;</span> <span class="op">}</span></span>
<span id="cb12-99"><a href="#cb12-99"></a>        <span class="kw">if</span> <span class="op">((</span>v <span class="op">&amp;</span> <span class="bn">0x3</span><span class="op">)</span> <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span> v <span class="op">&gt;&gt;=</span> <span class="dv">2</span><span class="op">;</span> c <span class="op">+=</span> <span class="dv">2</span><span class="op">;</span> <span class="op">}</span></span>
<span id="cb12-100"><a href="#cb12-100"></a>        c <span class="op">-=</span> v <span class="op">&amp;</span> <span class="bn">0x1</span><span class="op">;</span></span>
<span id="cb12-101"><a href="#cb12-101"></a>        <span class="kw">return</span> c<span class="op">;</span></span>
<span id="cb12-102"><a href="#cb12-102"></a>    <span class="op">}</span></span>
<span id="cb12-103"><a href="#cb12-103"></a><span class="op">}</span></span></code></pre></div>
</section>
</article>
<section>
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'dimchansky'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>		
</section>

		</div>

		<div id="footer">
			Site proudly generated by
			<a href="http://jaspervdj.be/hakyll">Hakyll</a>
		</div>
	</div>
	</body>
</html>
